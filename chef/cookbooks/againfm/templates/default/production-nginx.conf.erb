server {
	server_name <%= node['againfm']['host'] %>;

    # output compression saves bandwidth
    gzip on;
    gzip_http_version 1.1;
    gzip_vary on;
    gzip_comp_level 6;
    gzip_proxied any;
    gzip_types text/plain text/css application/json application/x-javascript text/javascript;

    # Disable gzip for certain browsers.
    gzip_disable “MSIE [1-6].(?!.*SV1)”;

    <% if node['againfm']['host'] == 'testing.again.fm' %>
    auth_basic "Area42";
    auth_basic_user_file /var/www/againfm/againfm.passwd;
    <% end %>

    error_page 404 /404.html;
    error_page 403 /403.html;
    error_page 500 502 503 504 /500.html;

    location ~ ^/(404|403|500)\.html {
        root /var/www/againfm/current/afm/web/templates;
    }

	location / {
        include uwsgi_params;
	    uwsgi_pass 127.0.0.1:3031;
	}

	# поисковые запросы идут на отдельного демона
	location /api/playlist/search {
		rewrite /api/playlist/search/([^/]+) /search/$1 break;
		proxy_pass http://127.0.0.1:6100;
	}

	location /static {
		expires 7d;
		add_header Cache-Control public;
		alias /var/www/againfm/current/afm/static;
	}

	location /admin/static {
		expires 7d;
		add_header Cache-Control public;
		alias /var/www/againfm/current/afm/admin/static;
	}

	location /mu-fa76d39d-fa0a0082-d8815605-c151db4b {
	    return 200 '42';
	}

	location = /robots.txt {
	    return 200 'User-Agent: *\nDisallow: /user/';
	}

	location = /favicon.ico {
	    root /var/www/againfm/current/afm/static/i;
	}

    location /nginx_status {
        stub_status on;
        access_log   off;
        allow 127.0.0.1;
        deny all;
    }
}
