/*! againfm 01-07-2013 */
function Comet(cometUrl){var host=document.location.host;this.constructor._registry||(this.constructor._registry={}),this._comet=null,this._iframeId="mpl"+(new Date).getTime(),this._iframeTag='<iframe id="'+this._iframeId+'"'+' onload="'+"Comet"+"._iframeLoaded(&quot;"+this._iframeId+'&quot;)"'+' src="'+cometUrl+"?host="+host+'"'+' style="position:absolute; visibility:hidden; width:1px; height:1px; left:-1000px; top:-1000px"'+"></iframe>",this._iframeCreated=!1,this._executeTimer=null,this._url=!1,this._callback=!1,this.constructor._registry[this._iframeId]=this,document.domain=host}var swfobject=function(){function callDomLoadFunctions(){if(!isDomLoaded){try{var t=doc.getElementsByTagName("body")[0].appendChild(createElement("span"));t.parentNode.removeChild(t)}catch(e){return}isDomLoaded=!0;for(var dl=domLoadFnArr.length,i=0;dl>i;i++)domLoadFnArr[i]()}}function addDomLoadEvent(fn){isDomLoaded?fn():domLoadFnArr[domLoadFnArr.length]=fn}function addLoadEvent(fn){if(typeof win.addEventListener!=UNDEF)win.addEventListener("load",fn,!1);else if(typeof doc.addEventListener!=UNDEF)doc.addEventListener("load",fn,!1);else if(typeof win.attachEvent!=UNDEF)addListener(win,"onload",fn);else if("function"==typeof win.onload){var fnOld=win.onload;win.onload=function(){fnOld(),fn()}}else win.onload=fn}function main(){plugin?testPlayerVersion():matchVersions()}function testPlayerVersion(){var b=doc.getElementsByTagName("body")[0],o=createElement(OBJECT);o.setAttribute("type",FLASH_MIME_TYPE);var t=b.appendChild(o);if(t){var counter=0;!function(){if(typeof t.GetVariable!=UNDEF){var d=t.GetVariable("$version");d&&(d=d.split(" ")[1].split(","),ua.pv=[parseInt(d[0],10),parseInt(d[1],10),parseInt(d[2],10)])}else if(10>counter)return counter++,setTimeout(arguments.callee,10),void 0;b.removeChild(o),t=null,matchVersions()}()}else matchVersions()}function matchVersions(){var rl=regObjArr.length;if(rl>0)for(var i=0;rl>i;i++){var id=regObjArr[i].id,cb=regObjArr[i].callbackFn,cbObj={success:!1,id:id};if(ua.pv[0]>0){var obj=getElementById(id);if(obj)if(!hasPlayerVersion(regObjArr[i].swfVersion)||ua.wk&&ua.wk<312)if(regObjArr[i].expressInstall&&canExpressInstall()){var att={};att.data=regObjArr[i].expressInstall,att.width=obj.getAttribute("width")||"0",att.height=obj.getAttribute("height")||"0",obj.getAttribute("class")&&(att.styleclass=obj.getAttribute("class")),obj.getAttribute("align")&&(att.align=obj.getAttribute("align"));for(var par={},p=obj.getElementsByTagName("param"),pl=p.length,j=0;pl>j;j++)"movie"!=p[j].getAttribute("name").toLowerCase()&&(par[p[j].getAttribute("name")]=p[j].getAttribute("value"));showExpressInstall(att,par,id,cb)}else displayAltContent(obj),cb&&cb(cbObj);else setVisibility(id,!0),cb&&(cbObj.success=!0,cbObj.ref=getObjectById(id),cb(cbObj))}else if(setVisibility(id,!0),cb){var o=getObjectById(id);o&&typeof o.SetVariable!=UNDEF&&(cbObj.success=!0,cbObj.ref=o),cb(cbObj)}}}function getObjectById(objectIdStr){var r=null,o=getElementById(objectIdStr);if(o&&"OBJECT"==o.nodeName)if(typeof o.SetVariable!=UNDEF)r=o;else{var n=o.getElementsByTagName(OBJECT)[0];n&&(r=n)}return r}function canExpressInstall(){return!isExpressInstallActive&&hasPlayerVersion("6.0.65")&&(ua.win||ua.mac)&&!(ua.wk&&ua.wk<312)}function showExpressInstall(att,par,replaceElemIdStr,callbackFn){isExpressInstallActive=!0,storedCallbackFn=callbackFn||null,storedCallbackObj={success:!1,id:replaceElemIdStr};var obj=getElementById(replaceElemIdStr);if(obj){"OBJECT"==obj.nodeName?(storedAltContent=abstractAltContent(obj),storedAltContentId=null):(storedAltContent=obj,storedAltContentId=replaceElemIdStr),att.id=EXPRESS_INSTALL_ID,(typeof att.width==UNDEF||!/%$/.test(att.width)&&parseInt(att.width,10)<310)&&(att.width="310"),(typeof att.height==UNDEF||!/%$/.test(att.height)&&parseInt(att.height,10)<137)&&(att.height="137"),doc.title=doc.title.slice(0,47)+" - Flash Player Installation";var pt=ua.ie&&ua.win?"ActiveX":"PlugIn",fv="MMredirectURL="+win.location.toString().replace(/&/g,"%26")+"&MMplayerType="+pt+"&MMdoctitle="+doc.title;if(typeof par.flashvars!=UNDEF?par.flashvars+="&"+fv:par.flashvars=fv,ua.ie&&ua.win&&4!=obj.readyState){var newObj=createElement("div");replaceElemIdStr+="SWFObjectNew",newObj.setAttribute("id",replaceElemIdStr),obj.parentNode.insertBefore(newObj,obj),obj.style.display="none",function(){4==obj.readyState?obj.parentNode.removeChild(obj):setTimeout(arguments.callee,10)}()}createSWF(att,par,replaceElemIdStr)}}function displayAltContent(obj){if(ua.ie&&ua.win&&4!=obj.readyState){var el=createElement("div");obj.parentNode.insertBefore(el,obj),el.parentNode.replaceChild(abstractAltContent(obj),el),obj.style.display="none",function(){4==obj.readyState?obj.parentNode.removeChild(obj):setTimeout(arguments.callee,10)}()}else obj.parentNode.replaceChild(abstractAltContent(obj),obj)}function abstractAltContent(obj){var ac=createElement("div");if(ua.win&&ua.ie)ac.innerHTML=obj.innerHTML;else{var nestedObj=obj.getElementsByTagName(OBJECT)[0];if(nestedObj){var c=nestedObj.childNodes;if(c)for(var cl=c.length,i=0;cl>i;i++)1==c[i].nodeType&&"PARAM"==c[i].nodeName||8==c[i].nodeType||ac.appendChild(c[i].cloneNode(!0))}}return ac}function createSWF(attObj,parObj,id){var r,el=getElementById(id);if(ua.wk&&ua.wk<312)return r;if(el)if(typeof attObj.id==UNDEF&&(attObj.id=id),ua.ie&&ua.win){var att="";for(var i in attObj)attObj[i]!=Object.prototype[i]&&("data"==i.toLowerCase()?parObj.movie=attObj[i]:"styleclass"==i.toLowerCase()?att+=' class="'+attObj[i]+'"':"classid"!=i.toLowerCase()&&(att+=" "+i+'="'+attObj[i]+'"'));var par="";for(var j in parObj)parObj[j]!=Object.prototype[j]&&(par+='<param name="'+j+'" value="'+parObj[j]+'" />');el.outerHTML='<object classid="clsid:D27CDB6E-AE6D-11cf-96B8-444553540000"'+att+">"+par+"</object>",objIdArr[objIdArr.length]=attObj.id,r=getElementById(attObj.id)}else{var o=createElement(OBJECT);o.setAttribute("type",FLASH_MIME_TYPE);for(var m in attObj)attObj[m]!=Object.prototype[m]&&("styleclass"==m.toLowerCase()?o.setAttribute("class",attObj[m]):"classid"!=m.toLowerCase()&&o.setAttribute(m,attObj[m]));for(var n in parObj)parObj[n]!=Object.prototype[n]&&"movie"!=n.toLowerCase()&&createObjParam(o,n,parObj[n]);el.parentNode.replaceChild(o,el),r=o}return r}function createObjParam(el,pName,pValue){var p=createElement("param");p.setAttribute("name",pName),p.setAttribute("value",pValue),el.appendChild(p)}function removeSWF(id){var obj=getElementById(id);obj&&"OBJECT"==obj.nodeName&&(ua.ie&&ua.win?(obj.style.display="none",function(){4==obj.readyState?removeObjectInIE(id):setTimeout(arguments.callee,10)}()):obj.parentNode.removeChild(obj))}function removeObjectInIE(id){var obj=getElementById(id);if(obj){for(var i in obj)"function"==typeof obj[i]&&(obj[i]=null);obj.parentNode.removeChild(obj)}}function getElementById(id){var el=null;try{el=doc.getElementById(id)}catch(e){}return el}function createElement(el){return doc.createElement(el)}function addListener(target,eventType,fn){target.attachEvent(eventType,fn),listenersArr[listenersArr.length]=[target,eventType,fn]}function hasPlayerVersion(rv){var pv=ua.pv,v=rv.split(".");return v[0]=parseInt(v[0],10),v[1]=parseInt(v[1],10)||0,v[2]=parseInt(v[2],10)||0,pv[0]>v[0]||pv[0]==v[0]&&pv[1]>v[1]||pv[0]==v[0]&&pv[1]==v[1]&&pv[2]>=v[2]?!0:!1}function createCSS(sel,decl,media,newStyle){if(!ua.ie||!ua.mac){var h=doc.getElementsByTagName("head")[0];if(h){var m=media&&"string"==typeof media?media:"screen";if(newStyle&&(dynamicStylesheet=null,dynamicStylesheetMedia=null),!dynamicStylesheet||dynamicStylesheetMedia!=m){var s=createElement("style");s.setAttribute("type","text/css"),s.setAttribute("media",m),dynamicStylesheet=h.appendChild(s),ua.ie&&ua.win&&typeof doc.styleSheets!=UNDEF&&doc.styleSheets.length>0&&(dynamicStylesheet=doc.styleSheets[doc.styleSheets.length-1]),dynamicStylesheetMedia=m}ua.ie&&ua.win?dynamicStylesheet&&typeof dynamicStylesheet.addRule==OBJECT&&dynamicStylesheet.addRule(sel,decl):dynamicStylesheet&&typeof doc.createTextNode!=UNDEF&&dynamicStylesheet.appendChild(doc.createTextNode(sel+" {"+decl+"}"))}}}function setVisibility(id,isVisible){if(autoHideShow){var v=isVisible?"visible":"hidden";isDomLoaded&&getElementById(id)?getElementById(id).style.visibility=v:createCSS("#"+id,"visibility:"+v)}}function urlEncodeIfNecessary(s){var regex=/[\\\"<>\.;]/,hasBadChars=null!=regex.exec(s);return hasBadChars&&typeof encodeURIComponent!=UNDEF?encodeURIComponent(s):s}var storedAltContent,storedAltContentId,storedCallbackFn,storedCallbackObj,dynamicStylesheet,dynamicStylesheetMedia,UNDEF="undefined",OBJECT="object",SHOCKWAVE_FLASH="Shockwave Flash",SHOCKWAVE_FLASH_AX="ShockwaveFlash.ShockwaveFlash",FLASH_MIME_TYPE="application/x-shockwave-flash",EXPRESS_INSTALL_ID="SWFObjectExprInst",ON_READY_STATE_CHANGE="onreadystatechange",win=window,doc=document,nav=navigator,plugin=!1,domLoadFnArr=[main],regObjArr=[],objIdArr=[],listenersArr=[],isDomLoaded=!1,isExpressInstallActive=!1,autoHideShow=!0,ua=function(){var w3cdom=typeof doc.getElementById!=UNDEF&&typeof doc.getElementsByTagName!=UNDEF&&typeof doc.createElement!=UNDEF,u=nav.userAgent.toLowerCase(),p=nav.platform.toLowerCase(),windows=p?/win/.test(p):/win/.test(u),mac=p?/mac/.test(p):/mac/.test(u),webkit=/webkit/.test(u)?parseFloat(u.replace(/^.*webkit\/(\d+(\.\d+)?).*$/,"$1")):!1,ie=!1,playerVersion=[0,0,0],d=null;if(typeof nav.plugins!=UNDEF&&typeof nav.plugins[SHOCKWAVE_FLASH]==OBJECT)d=nav.plugins[SHOCKWAVE_FLASH].description,!d||typeof nav.mimeTypes!=UNDEF&&nav.mimeTypes[FLASH_MIME_TYPE]&&!nav.mimeTypes[FLASH_MIME_TYPE].enabledPlugin||(plugin=!0,ie=!1,d=d.replace(/^.*\s+(\S+\s+\S+$)/,"$1"),playerVersion[0]=parseInt(d.replace(/^(.*)\..*$/,"$1"),10),playerVersion[1]=parseInt(d.replace(/^.*\.(.*)\s.*$/,"$1"),10),playerVersion[2]=/[a-zA-Z]/.test(d)?parseInt(d.replace(/^.*[a-zA-Z]+(.*)$/,"$1"),10):0);else if(typeof win.ActiveXObject!=UNDEF)try{var a=new ActiveXObject(SHOCKWAVE_FLASH_AX);a&&(d=a.GetVariable("$version"),d&&(ie=!0,d=d.split(" ")[1].split(","),playerVersion=[parseInt(d[0],10),parseInt(d[1],10),parseInt(d[2],10)]))}catch(e){}return{w3:w3cdom,pv:playerVersion,wk:webkit,ie:ie,win:windows,mac:mac}}();return function(){ua.w3&&((typeof doc.readyState!=UNDEF&&"complete"==doc.readyState||typeof doc.readyState==UNDEF&&(doc.getElementsByTagName("body")[0]||doc.body))&&callDomLoadFunctions(),isDomLoaded||(typeof doc.addEventListener!=UNDEF&&doc.addEventListener("DOMContentLoaded",callDomLoadFunctions,!1),ua.ie&&ua.win&&(doc.attachEvent(ON_READY_STATE_CHANGE,function(){"complete"==doc.readyState&&(doc.detachEvent(ON_READY_STATE_CHANGE,arguments.callee),callDomLoadFunctions())}),win==top&&function(){if(!isDomLoaded){try{doc.documentElement.doScroll("left")}catch(e){return setTimeout(arguments.callee,0),void 0}callDomLoadFunctions()}}()),ua.wk&&function(){return isDomLoaded?void 0:/loaded|complete/.test(doc.readyState)?(callDomLoadFunctions(),void 0):(setTimeout(arguments.callee,0),void 0)}(),addLoadEvent(callDomLoadFunctions)))}(),function(){ua.ie&&ua.win&&window.attachEvent("onunload",function(){for(var ll=listenersArr.length,i=0;ll>i;i++)listenersArr[i][0].detachEvent(listenersArr[i][1],listenersArr[i][2]);for(var il=objIdArr.length,j=0;il>j;j++)removeSWF(objIdArr[j]);for(var k in ua)ua[k]=null;ua=null;for(var l in swfobject)swfobject[l]=null;swfobject=null})}(),{registerObject:function(objectIdStr,swfVersionStr,xiSwfUrlStr,callbackFn){if(ua.w3&&objectIdStr&&swfVersionStr){var regObj={};regObj.id=objectIdStr,regObj.swfVersion=swfVersionStr,regObj.expressInstall=xiSwfUrlStr,regObj.callbackFn=callbackFn,regObjArr[regObjArr.length]=regObj,setVisibility(objectIdStr,!1)}else callbackFn&&callbackFn({success:!1,id:objectIdStr})},getObjectById:function(objectIdStr){return ua.w3?getObjectById(objectIdStr):void 0},embedSWF:function(swfUrlStr,replaceElemIdStr,widthStr,heightStr,swfVersionStr,xiSwfUrlStr,flashvarsObj,parObj,attObj,callbackFn){var callbackObj={success:!1,id:replaceElemIdStr};ua.w3&&!(ua.wk&&ua.wk<312)&&swfUrlStr&&replaceElemIdStr&&widthStr&&heightStr&&swfVersionStr?(setVisibility(replaceElemIdStr,!1),addDomLoadEvent(function(){widthStr+="",heightStr+="";var att={};if(attObj&&typeof attObj===OBJECT)for(var i in attObj)att[i]=attObj[i];att.data=swfUrlStr,att.width=widthStr,att.height=heightStr;var par={};if(parObj&&typeof parObj===OBJECT)for(var j in parObj)par[j]=parObj[j];if(flashvarsObj&&typeof flashvarsObj===OBJECT)for(var k in flashvarsObj)typeof par.flashvars!=UNDEF?par.flashvars+="&"+k+"="+flashvarsObj[k]:par.flashvars=k+"="+flashvarsObj[k];if(hasPlayerVersion(swfVersionStr)){var obj=createSWF(att,par,replaceElemIdStr);att.id==replaceElemIdStr&&setVisibility(replaceElemIdStr,!0),callbackObj.success=!0,callbackObj.ref=obj}else{if(xiSwfUrlStr&&canExpressInstall())return att.data=xiSwfUrlStr,showExpressInstall(att,par,replaceElemIdStr,callbackFn),void 0;setVisibility(replaceElemIdStr,!0)}callbackFn&&callbackFn(callbackObj)})):callbackFn&&callbackFn(callbackObj)},switchOffAutoHideShow:function(){autoHideShow=!1},ua:ua,getFlashPlayerVersion:function(){return{major:ua.pv[0],minor:ua.pv[1],release:ua.pv[2]}},hasFlashPlayerVersion:hasPlayerVersion,createSWF:function(attObj,parObj,replaceElemIdStr){return ua.w3?createSWF(attObj,parObj,replaceElemIdStr):void 0},showExpressInstall:function(att,par,replaceElemIdStr,callbackFn){ua.w3&&canExpressInstall()&&showExpressInstall(att,par,replaceElemIdStr,callbackFn)},removeSWF:function(objElemIdStr){ua.w3&&removeSWF(objElemIdStr)},createCSS:function(selStr,declStr,mediaStr,newStyleBoolean){ua.w3&&createCSS(selStr,declStr,mediaStr,newStyleBoolean)},addDomLoadEvent:addDomLoadEvent,addLoadEvent:addLoadEvent,getQueryParamValue:function(param){var q=doc.location.search||doc.location.hash;if(q){if(/\?/.test(q)&&(q=q.split("?")[1]),null==param)return urlEncodeIfNecessary(q);for(var pairs=q.split("&"),i=0;i<pairs.length;i++)if(pairs[i].substring(0,pairs[i].indexOf("="))==param)return urlEncodeIfNecessary(pairs[i].substring(pairs[i].indexOf("=")+1))}return""},expressInstallCallback:function(){if(isExpressInstallActive){var obj=getElementById(EXPRESS_INSTALL_ID);obj&&storedAltContent&&(obj.parentNode.replaceChild(storedAltContent,obj),storedAltContentId&&(setVisibility(storedAltContentId,!0),ua.ie&&ua.win&&(storedAltContent.style.display="block")),storedCallbackFn&&storedCallbackFn(storedCallbackObj)),isExpressInstallActive=!1}}}}();Comet._iframeLoaded=function(id){var th=this._registry[id];setTimeout(function(){var iframe=document.getElementById(id);th._comet=iframe.contentWindow.Comet},50)},Comet._buildUrl=function(params,url){if(!params)return url;var parts=[];return angular.forEach(params,function(value,key){null!=value&&void 0!=value&&(angular.isObject(value)&&(value=angular.toJson(value)),parts.push(encodeURIComponent(key)+"="+encodeURIComponent(value)))}),parts=parts.join("&"),url?url+(-1==url.indexOf("?")?"?":"&")+parts:parts},Comet.prototype.subscribe=function(url,params,callback){angular.isFunction(params)&&!callback&&(callback=params,params=null),params&&(url=Comet._buildUrl(params,url)),this._url=url,this._callback=callback,this.execute()},Comet.prototype.unsubscribe=function(){this._url=!1,this._callback=!1,this.execute()},Comet.prototype.execute=function(){if(!this._iframeCreated){var div=document.createElement("DIV");div.innerHTML=this._iframeTag,document.body.appendChild(div),this._iframeCreated=!0}this._executeTimer&&(clearTimeout(this._executeTimer),this._executeTimer=null);var self=this;return this._comet?(this._comet.execute(this._url,this._callback),void 0):(this._executeTimer=setTimeout(function(){self.execute()},30),void 0)},angular.module("afm.comet",[]).provider("comet",function(){this.url="",this.$get=function(){return new Comet(this.url)},this.setUrl=function(url){this.url=url}}),angular.module("afm.base").factory("$transition",["$q","$timeout","$rootScope",function($q,$timeout,$rootScope){function findEndEventName(endEventNames){for(var name in endEventNames)if(void 0!==transElement.style[name])return endEventNames[name]}var $transition=function(element,trigger,options){options=options||{};var deferred=$q.defer(),endEventName=$transition[options.animation?"animationEndEventName":"transitionEndEventName"],transitionEndHandler=function(){$rootScope.$apply(function(){element.unbind(endEventName,transitionEndHandler),deferred.resolve(element)})};return endEventName&&element.bind(endEventName,transitionEndHandler),$timeout(function(){angular.isString(trigger)?element.addClass(trigger):angular.isFunction(trigger)?trigger(element):angular.isObject(trigger)&&element.css(trigger),endEventName||deferred.resolve(element)}),deferred.promise.cancel=function(){endEventName&&element.unbind(endEventName,transitionEndHandler),deferred.reject("Transition cancelled")},deferred.promise},transElement=document.createElement("trans"),transitionEndEventNames={WebkitTransition:"webkitTransitionEnd",MozTransition:"transitionend",OTransition:"oTransitionEnd",transition:"transitionend"},animationEndEventNames={WebkitTransition:"webkitAnimationEnd",MozTransition:"animationend",OTransition:"oAnimationEnd",transition:"animationend"};return $transition.transitionEndEventName=findEndEventName(transitionEndEventNames),$transition.animationEndEventName=findEndEventName(animationEndEventNames),$transition}]),angular.module("afm.base").directive("uiAnimate",["$timeout",function($timeout){return{restrict:"A",link:function($scope,element,attrs){var opts={};attrs.uiAnimate&&(opts=$scope.$eval(attrs.uiAnimate),angular.isString(opts)&&(opts={"class":opts})),opts=angular.extend({"class":"ui-animate"},opts),element.addClass(opts["class"]),$timeout(function(){element.removeClass(opts["class"])},20)}}}]),angular.module("afm.sound",["afm.base"]).factory("player",["$rootScope","$log","storage","audioEngine","flash","config",function($rootScope,$log,storage,audioEngine,flash,config){var obj={url:null,player:null,muted:!1,playing:!1,volume:config.defaultVolume,defaultVolume:config.defaultVolume,play:function(url){url&&(this.url=url),this.player&&this.url&&(this.player.playStream(this.url),this.playing=!0)},getParams:function(){var params=[];return this.player&&this.player.canPlayType&&(this.player.canPlayType("audio/mpeg")&&params.push("mp3"),this.player.canPlayType("audio/ogg")&&params.push("ogg"),this.player.html5&&params.push("html5")),params.join(",")},stop:function(){this.player&&this.player.stopStream(),this.playing=!1},setVolume:function(volume){if(this.player){var expVol=Math.sin(volume*Math.PI/2);this.player.setVolume(expVol)}},updateVolume:function(volume){this.volume=volume,this.setVolume(volume),storage.put("volume",parseFloat(volume))},loadVolume:function(){var volume=parseFloat(storage.get("volume"));isNaN(volume)&&(volume=this.defaultVolume),this.updateVolume(volume)},callback:function(event){"stopped"==event&&(this.playing=!1,$rootScope.$broadcast("playerStopped")),"playing"==event&&(this.playing=!0,$rootScope.$broadcast("playerPlaying")),"ready"==event&&(this.player=document.getElementById("flash-player-engine"),this.setVolume(this.volume),this.play()),$rootScope.$apply()},init:function(){this.loadVolume(),flash.present()||this.tryHtml5Fallback()},tryHtml5Fallback:function(){var player=audioEngine(_.bind(this.callback,this));player&&player.canPlayType("audio/mpeg")?($log.log("use html5 fallback"),this.player=player):this.player=null}};return obj.init(),obj}]).factory("audioEngine",["$document",function($document){return function(eventCallback){var audio=$document[0].createElement("audio");if(audio.canPlayType)return audio.addEventListener("playing",function(){eventCallback("playing")}),audio.addEventListener("error",function(){eventCallback("stopped")}),{html5:!0,playStream:function(url){audio.src=url,audio.play()},stopStream:function(){audio.pause(),audio.src=""},setVolume:function(volume){audio.volume=volume},canPlayType:function(type){return!!audio.canPlayType(type).replace(/^no$/,"")}}}}]).factory("flash",function(){return{loaded:null,embed:function(src,id){return swfobject.embedSWF(src,id,1,1,"10",!1,{},{allowScriptAccess:"always",wmode:"transparent"},{})},present:function(){return swfobject.hasFlashPlayerVersion("10")}}}).directive("flashEngine",["$window","$rootScope","player","flash",function($window,$rootScope,player,flash){return $window.flashPlayerCallback=function(event){player.callback(event)},{restrict:"C",link:function(scope,element,attrs){flash.embed(attrs.src,attrs.id)}}}]),angular.module("afm.player",["afm.base","afm.sound","afm.comet","afm.user"]).config(["$routeProvider","cometProvider","$stateProvider","$locationProvider",function($routeProvider,cometProvider,$stateProvider,$locationProvider){cometProvider.setUrl("http://comet."+document.location.host),$locationProvider.html5Mode(!0),$stateProvider.state("home",{url:"/",template:'<div ng-init="visible=false"></div>'}),$stateProvider.state("listen",{url:"/listen/:radioId",controller:"ListenCtrl"}),$stateProvider.state("favorite_radio",{templateUrl:"favorite_radio.html",controller:"FavoriteRadioCtrl"}),$stateProvider.state("onair",{templateProvider:function(Radio,$http){var url="/_radio/"+Radio.cur.id+"/onair_history";return $http.get(url).then(function(response){return response.data})}})}]).controller("ListenCtrl",["$rootScope","$stateParams","$http","Radio","trackEvent",function($rootScope,$stateParams,$http,Radio,trackEvent){Radio.cur.id!=$stateParams.radioId&&(Radio.reset(),$http.get("/_radio/"+$stateParams.radioId).success(function(radio){Radio.listen(radio)}).error(function(resp,statusCode){trackEvent("player",{act:"listen_error",rid:parseInt($stateParams.radioId)}),$rootScope.$broadcast("radioListenError",statusCode)}))}]).factory("Radio",["$rootScope","$http","player",function($rootScope,$http,player){return{cur:{},stream:{},set:function(radio){this.cur.id=radio.id,this.cur.title=radio.title,this.cur.description=radio.description||""},reset:function(){this.set({}),this.stream={},player.stop()},listen:function(radio){radio.id!=this.cur.id&&this.play(radio),this.set(radio)},play:function(radio){var self=this;radio.stream?(self.stream=angular.copy(radio.stream),player.play(self.stream.url)):$http.get("/_radio/"+radio.id+"/stream").success(function(stream){self.stream=stream,player.play(stream.url)}).error(function(resp,statusCode){$rootScope.$broadcast("radioListenError",statusCode)}),$rootScope.$broadcast("radioListen",radio)}}}]).factory("favorites",["$rootScope","user","storage","UserFavorite","collectionFactory",function($rootScope,user,storage,UserFavorite,collectionFactory){var name="favorites"+(user.isLogged()?"_user"+user.get().id:""),coll=collectionFactory(name);user.isLogged()&&(coll.removeAll(),UserFavorite.list(function(objects){angular.forEach(objects,function(obj){coll.add(obj.id,obj)})}));var favorites=angular.extend({},coll,{add:function(id,obj){coll.add(id,obj),user.isLogged()&&UserFavorite.add(id)},remove:function(id){coll.remove(id),user.isLogged()&&UserFavorite.remove(id)}});return favorites}]).factory("UserFavorite",["$http",function($http){return{add:function(id){$http.post("/_user/favorites/"+id+"/add")},remove:function(id){$http.post("/_user/favorites/"+id+"/remove")},list:function(cb){$http.get("/_user/favorites").success(function(response){cb(response.objects)})}}}]).directive("spinner",function(){return{restrict:"CA",templateUrl:"spinner.html",link:function($scope,element){$scope.$on("loading",function(){element.css("display","block")}),$scope.$on("loaded",function(){element.css("display","none")})}}}).factory("history",["collectionFactory","config",function(collectionFactory,config){var history=collectionFactory("history",{capacity:config.listenHistorySize});return angular.extend(history,{getPrevious:function(){var list=history.list();return list.length>1?list[1]:void 0}})}]).controller("PlaylistCtrl",["$scope","$http","$timeout","$location","history","Radio",function($scope,$http,$timeout,$location,history,Radio){function resetSearch(){$scope.searchQuery&&($scope.searchQuery="",$scope.prevTab=null)}$scope.searchQuery="",$scope.tabs=[],$scope.playlist=[],$scope.addTab=function(id,title){$scope.tabs.push({id:id,title:title})},$scope.initTabs=function(){angular.forEach($scope.genres,function(genre){$scope.addTab("genre/"+genre.id,genre.title)}),$scope.selectTab($scope.tabs[0].id)},$scope.$on("playerFreePlay",function(){$scope.playlist.length&&$location.path("/listen/"+$scope.playlist[0].id)}),$scope.$on("playerPlaying",function(){history.add(Radio.cur.id,Radio.cur)}),$scope.isHistoryEmpty=function(){return!0},$scope.noSearchResults=function(){return $scope.currentTab&&-1!==$scope.currentTab.indexOf("search")&&!$scope.playlist.length},$scope.search=function(searchQuery){searchQuery?($scope.prevTab||($scope.prevTab=$scope.currentTab),$scope.selectTab("search?q="+searchQuery)):$scope.prevTab&&$scope.selectTab($scope.prevTab)};var searchThrottle;$scope.$watch("searchQuery",function(searchQuery){searchThrottle&&$timeout.cancel(searchThrottle),searchThrottle=$timeout(function(){$scope.search(searchQuery)},200)}),$scope.selectTab=function(tabId){return-1==tabId.indexOf("search")&&resetSearch(),$scope.currentTab=tabId,"history"==$scope.currentTab?($scope.playlist=history.list(),void 0):($scope.$broadcast("loading"),$http.get("/_radio/"+tabId).success(function(response){$scope.playlist=response.objects,$scope.$broadcast("loaded")}).error(function(){$scope.playlist=[],$scope.$broadcast("loaded")}),void 0)},$scope.tabClass=function(tabId){var selected=tabId==$scope.currentTab;return{selected:selected}}}]).directive("volumeSlider",["$rootScope","$document",function($rootScope,$document){return{restrict:"C",link:function(scope,element){function posToValue(pos){return pos?pos/lineWidth*max:0}function updateValue(value,skipScope){value=clamp(parseFloat(value),0,max),value=Math.round(100*value)/100;var pos=0;value>0&&(pos=value/max*lineWidth),element.css("left",Math.round(pos)+"px"),skipScope||(scope.volume=value,scope.$apply())}function clamp(value,min,max){return min>=value&&(value=min),value>=max&&(value=max),value}var startValue,startPosition,volumeLine=element.parent(),lineWidth=volumeLine.prop("offsetWidth")-element.prop("offsetWidth"),max=1;element.bind("click",function(e){e.stopPropagation()}),scope.$watch("volume",function(volume){updateValue(volume,"skipScope")}),volumeLine.bind("click",function(e){var value=posToValue(e.offsetX-element.prop("offsetWidth")/2);updateValue(value)}),element.bind("mousedown",function(e){startPosition=e.pageX,startValue=parseFloat(scope.volume)||0,$document.find("body").addClass("moving")}),$document.bind("mousemove",function(e){if(startPosition){var pos=startPosition-e.pageX,value=startValue-pos/lineWidth*max;value=clamp(value,0,max),updateValue(value)}}),$document.bind("mouseup",function(){startPosition=startValue=null,$document.find("body").removeClass("moving")})}}}]).controller("PlayerCtrl",["$scope","Radio","title","trackEvent",function($scope,Radio,title,trackEvent){function ts(){return Math.round(+new Date/1e3)}$scope.currentRadio=Radio.cur,$scope.currentClass=function(radio){return{selected:Radio.cur&&Radio.cur.id==radio.id}},$scope.$on("radioListen",function(ev,radio){title.change(radio.title)});var playStart=0;$scope.$on("playerPlaying",function(){playStart=ts(),trackEvent("player",{act:"play",sid:Radio.stream.id})}),$scope.$on("playerStopped",function(){playStart&&trackEvent("player",{act:"stop",dur:ts()-playStart}),playStart=0})}]).controller("PlayerControlsCtrl",["$scope","$http","$location","player","history","Radio","trackEvent",function($scope,$http,$location,player,history,Radio,trackEvent){$scope.play=function(){Radio.cur.id?Radio.play(Radio.cur):$scope.$root.$broadcast("playerFreePlay")},$scope.selectRadio=function(radio){$location.path("/listen/"+radio.id)},$scope.stop=function(){player.stop()},$scope.randomRadio=function(){$http.get("/_radio/random").success(function(radio){trackEvent("player",{act:"random",rid:radio.id}),$scope.selectRadio(radio)})},$scope.previousRadio=function(){var radio=history.getPrevious();radio&&(trackEvent("player",{act:"previous",rid:radio.id}),$scope.selectRadio(radio))},$scope.isPlaying=function(){return player.playing},$scope.volume=player.volume,$scope.$watch("volume",function(volume){player.updateVolume(volume)})}]).controller("FavoritesCtrl",["$scope","favorites","$filter","$state",function($scope,favorites,$filter,$state){$scope.getFavorites=function(){return favorites.list()},$scope.showModal=function(){$state.transitionTo("favorite_radio")}}]).directive("clock",["$timeout","dateFilter",function($timeout,dateFilter){return function(scope,element,attrs){function updateTime(){var date=new Date,delimiter=date.getSeconds()%2?"&nbsp;":":",text=dateFilter(date,"HH mm").replace(" ",'<span class="dots">'+delimiter+"</span>");element.html(text)}function updateLater(){timeoutId=$timeout(function(){updateTime(),updateLater()},1e3)}var timeoutId;scope.$watch(attrs.clock,function(value){value?(updateLater(),element.css("display","block")):($timeout.cancel(timeoutId),element.css("display","none"))}),element.bind("$destroy",function(){$timeout.cancel(timeoutId)})}}]).factory("onair",["$rootScope","user","comet","config",function($rootScope,user,comet,config){function onAir(response){onair=response,$rootScope.$apply()}var onair={};return{get:function(){return onair&&onair.air},getListeners:function(){return onair&&onair.listeners||0},subscribe:function(radioId){comet.unsubscribe();var params={wait:config.cometWait};user.isLogged()&&(params.uid=user.id),comet.subscribe("/air/"+radioId,params,onAir)},unsubscribe:function(){onair=null,comet.unsubscribe()}}}]).controller("FavoriteRadioCtrl",["$scope","favorites",function($scope,favorites){$scope.getList=function(){return favorites.list()},$scope.isEmpty=function(){return favorites.isEmpty()},$scope.remove=function(id){favorites.remove(id)}}]).controller("DisplayCtrl",["$scope","$state","Radio","favorites","onair","player",function($scope,$state,Radio,favorites,onair,player){$scope.titleClass=function(){return{starred:Radio.cur.id&&favorites.exists(Radio.cur.id)}},$scope.star=function(){Radio.cur.id&&(favorites.exists(Radio.cur.id)?favorites.remove(Radio.cur.id):favorites.add(Radio.cur.id,Radio.cur))},$scope.isInfoVisible=function(){return Radio.cur.id&&!$scope.error},$scope.isClockVisible=function(){return!Radio.cur.id&&!$scope.error},$scope.$on("playerPlaying",function(){onair.subscribe(Radio.cur.id)}),$scope.$on("playerStopped",function(){onair.unsubscribe()}),$scope.$on("radioListen",function(){$scope.error=!1}),$scope.$on("radioListenError",function(error){$scope.error=error}),$scope.hasAirInfo=function(){var air=onair.get();return air&&air.id},$scope.getListeners=onair.getListeners,$scope.getSubtitle=function(){var air=onair.get();return air&&air.title&&player.playing?air.title:Radio.cur.description},$scope.getCaption=function(){return[$scope.getSubtitle()]},$scope.showAir=function(){$state.transitionTo("onair")}}]);